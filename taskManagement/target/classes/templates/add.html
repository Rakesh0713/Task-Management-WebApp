<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TaskFlow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            margin: 0;
            background-color: #f9f9fc;
            color: #102030;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }
        .header-buttons {
            display: flex;
            gap: 16px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-login {
            background-color: #fff;
            border: 1px solid #102030;
        }
        .btn-add {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 24px;
            gap: 16px;
        }
        .stat-box {
            flex: 1;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .stat-box h2 {
            margin: 0;
            font-size: 28px;
        }
        .filters {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        .filter-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .filter-active {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        .tasks-container {
            max-width: 800px;
            margin: auto;
        }
        .task-card {
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-info h3 {
            margin: 0;
            font-size: 18px;
        }
        .task-info p {
            margin: 4px 0;
            color: #666;
        }
        .priority-tag {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        .low { background-color: #d4f9e4; color: #059669; }
        .medium { background-color: #fef3c7; color: #b45309; }
        .high { background-color: #fee2e2; color: #b91c1c; }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
        }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .modal-content .btn {
            width: 100%;
            margin-top: 10px;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #888;
        }
        .show { display: flex !important; }
        .completed h3 {
            text-decoration: line-through;
            color: #aaa;
        }
        .auth-section-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .auth-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            position: relative;
        }
        .auth-modal-content .auth-tabs {
            margin-bottom: 20px;
        }
        .auth-modal-content .auth-form input {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .auth-modal-content .auth-form button {
            width: 100%;
            margin-top: 10px;
            background: #30e3ca;
            color: #000;
        }
        .auth-modal-content .auth-form {
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        .auth-modal-content .auth-show {
            display: flex !important;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>TaskFlow</h1>
    <div class="header-buttons">
        <button class="btn btn-login" onclick="showAuthModal()">Login</button>
        <button class="btn btn-add" onclick="showModal()">+ Add Task</button>
    </div>
</div>

<div class="stats">
    <div class="stat-box">
        <p>Total Tasks</p><h2 id="totalTasks">0</h2>
    </div>
    <div class="stat-box">
        <p>Completed</p><h2 id="completedTasks">0</h2>
    </div>
    <div class="stat-box">
        <p>Pending</p><h2 id="pendingTasks">0</h2>
    </div>
    <div class="stat-box">
        <p>Completion Rate</p><h2 id="completionRate">0%</h2>
    </div>
</div>

<div class="filters">
    <button class="filter-btn filter-active" onclick="filterTasks('all', event)">All Tasks</button>
    <button class="filter-btn" onclick="filterTasks('Pending', event)">Pending</button>
    <button class="filter-btn" onclick="filterTasks('Completed', event)">Completed</button>
</div>

<div class="tasks-container" id="tasksList">
    <!-- Dynamic Tasks will be inserted here -->
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
        <h2>Add New Task</h2>
        <input type="text" placeholder="Task Title" id="taskTitle">
        <textarea placeholder="Description" id="taskDesc"></textarea>
        <select id="taskPriority">
            <option value="LOW">Low Priority</option>
            <option value="MEDIUM">Medium Priority</option>
            <option value="HIGH">High Priority</option>
        </select>
        <input type="date" id="taskDeadline">
        <button class="btn btn-add" onclick="addTask()">+ Add Task</button>
    </div>
</div>

<div class="auth-section-modal" id="authModal">
    <div class="auth-modal-content">
        <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
        <div class="auth-tabs">
            <button id="regTab" class="active" onclick="showAuthForm('register')">Register</button>
            <button id="loginTab" onclick="showAuthForm('login')">Login</button>
        </div>
        <form class="auth-form auth-show" id="registerForm" onsubmit="register(event)">
            <input type="text" placeholder="Full Name" id="regName" required>
            <input type="email" placeholder="Email" id="regEmail" required>
            <input type="password" placeholder="Password" id="regPassword" required>
            <button class="btn">Register</button>
        </form>
        <form class="auth-form" id="loginForm" onsubmit="login(event)">
            <input type="email" placeholder="Email" id="loginEmail" required>
            <input type="password" placeholder="Password" id="loginPassword" required>
            <button class="btn">Login</button>
        </form>
    </div>
</div>

<script>
    let tasks = [];
    let currentFilter = 'all';
    let isLoggedIn = false;

    async function fetchTasks() {
        const res = await fetch('/api/task/list');
        if (res.ok) {
            tasks = await res.json();
            renderTasks(currentFilter);
        } else {
            tasks = [];
            renderTasks(currentFilter);
        }
    }

    function renderTasks(filter = "all") {
        const container = document.getElementById("tasksList");
        container.innerHTML = "";
        const filtered = tasks.filter(t =>
            filter === "all" || t.status === filter
        );
        filtered.forEach(task => {
            const div = document.createElement("div");
            div.className = `task-card ${task.status}`;
            div.innerHTML = `
                <div class="task-info">
                    <h3>${task.title}</h3>
                    <p>${task.description}</p>
                    <p>${task.deadline || ''}</p>
                </div>
                <div>
                    <span class="priority-tag ${task.priority.toLowerCase()}">${task.priority.charAt(0) + task.priority.slice(1).toLowerCase()}</span>
                    <input type="radio" name="complete-${task.id}" ${task.status === 'Completed' ? 'checked' : ''} onclick="markCompleted(${task.id}, this.checked)" title="Mark as completed" />
                    <button onclick="deleteTask(${task.id})" style="margin-left:10px;">🗑️</button>
                </div>
            `;
            container.appendChild(div);
        });
        document.getElementById("totalTasks").innerText = tasks.length;
        const completed = tasks.filter(t => t.status === "Completed").length;
        const pending = tasks.filter(t => t.status !== "Completed").length;
        document.getElementById("completedTasks").innerText = completed;
        document.getElementById("pendingTasks").innerText = pending;
        document.getElementById("completionRate").innerText = tasks.length ? Math.round((completed / tasks.length) * 100) + "%" : "0%";
    }

    function showModal() {
        if (!isLoggedIn) { showAuthModal(); return; }
        document.getElementById("taskModal").classList.add("show");
    }

    function showAuthModal() {
        document.getElementById("authModal").classList.add("show");
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove("show");
    }

    async function addTask() {
        const title = document.getElementById("taskTitle").value;
        const description = document.getElementById("taskDesc").value;
        const priority = document.getElementById("taskPriority").value;
        const deadline = document.getElementById("taskDeadline").value;
        const res = await fetch('/api/task/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, priority, deadline, status: 'Pending' })
        });
        if (res.ok) {
            closeModal('taskModal');
            await fetchTasks();
        } else {
            alert('Failed to add task');
        }
    }

    async function deleteTask(id) {
        const res = await fetch(`/api/task/delete/${id}`, { method: 'DELETE' });
        if (res.ok) {
            await fetchTasks();
        } else {
            alert('Failed to delete task');
        }
    }

    async function markCompleted(id, checked) {
        const status = checked ? 'Completed' : 'Pending';
        const res = await fetch(`/api/task/update/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        if (res.ok) {
            await fetchTasks();
        } else {
            alert('Failed to update task');
        }
    }

    function filterTasks(type, event) {
        currentFilter = type;
        document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("filter-active"));
        if (event) event.target.classList.add("filter-active");
        renderTasks(type);
    }

    function showAuthForm(type) {
        document.getElementById("registerForm").classList.remove("auth-show");
        document.getElementById("loginForm").classList.remove("auth-show");
        document.getElementById("regTab").classList.remove("active");
        document.getElementById("loginTab").classList.remove("active");
        if (type === "register") {
            document.getElementById("registerForm").classList.add("auth-show");
            document.getElementById("regTab").classList.add("active");
        } else {
            document.getElementById("loginForm").classList.add("auth-show");
            document.getElementById("loginTab").classList.add("active");
        }
    }

    async function register(e) {
        e.preventDefault();
        const user_fname = document.getElementById("regName").value;
        const user_email = document.getElementById("regEmail").value;
        const user_pass = document.getElementById("regPassword").value;
        const res = await fetch('/api/user/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_fname, user_email, user_pass })
        });
        const data = await res.json();
        if (data.success) {
            alert('Registration successful! Please login.');
            showAuthForm('login');
        } else {
            alert(data.error || 'Registration failed');
        }
    }

    async function login(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const res = await fetch('/api/user/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            isLoggedIn = true;
            closeModal('authModal');
            await fetchTasks();
        } else {
            alert(data.error || 'Login failed');
        }
    }

    async function logout() {
        const res = await fetch('/api/user/logout', { method: 'POST' });
        if (res.ok) {
            isLoggedIn = false;
            tasks = [];
            renderTasks();
            showAuthModal();
        }
    }

    // Attach logout to header button if needed
    document.querySelector('.btn-login').addEventListener('dblclick', logout);

    // On load, try to fetch tasks (if session is valid)
    fetchTasks();
</script>

</body>
</html>
